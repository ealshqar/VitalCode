//////////////////////////////////////////////////////////////////////////////
//  
//  <sourcefile name="XtraTabPageBuilding.cs" creationdate="8/12/08" owner="anasa" >
//
//      <project>McKinstry TCO Application</project>
//  
//      <description>The tab page of the building entity</description>
//      
//      <copyright year="2008" company="McKinstry">
//          <notice>
//              Copyright © 2008 McKinstry. All rights reserved
//  
//              Developed for McKinstry by
//                  Equiom - MENA
//                  www.equiom.com
//          </notice>
//  
//  	<history date="8/12/08" modby="anasa">created</history>
//  
//////////////////////////////////////////////////////////////////////////////

#region Library Calls

//---------------------------------------------------------------------------------------------
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Windows.Forms;
using DevExpress.XtraEditors;
using DevExpress.XtraEditors.Controls;
using DevExpress.XtraGrid.Views.Grid.ViewInfo;
using Equiom.Tco.BusinessLogicLayer;
using Equiom.Tco.DataAccessLayer;
using TCO.DesktopClientDevexpress.Properties;
using Application=Equiom.Tco.Common.Application;
using Component=Equiom.Tco.BusinessLogicLayer.Component;

//---------------------------------------------------------------------------------------------

#endregion

namespace TCO.DesktopClientDevexpress
{
    public partial class XtraTabPageBuilding : XtraTabPageEntity
    {
        #region Constants

        //---------------------------------------------------------------------------------------------
        private const string ADD_COMPONENTS_ERROR = "You are not allowed to add component before saving the building";
        //---------------------------------------------------------------------------------------------

        #endregion

        #region Fields

        //---------------------------------------------------------------------------------------------
        private bool isDeletingComponents;
        public bool validateContacts;
        //---------------------------------------------------------------------------------------------

        #endregion

        #region Properties

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Return the tab object as a building after casting its value
        /// </summary>
        public Building TabBuilding
        {
            get { return TabObject as Building; }
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Constructors

        //---------------------------------------------------------------------------------------------
        public XtraTabPageBuilding()
        {
            InitializeComponent();
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Methods

        #region Overriding Methods

        #region Initialization & Binding

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Initialize the building object of the tab if it is new tab and initialize some properties
        /// </summary>
        /// <param name="isNew">Determine if the tab is new or opened tab</param>
        /// <param name="parentObject"></param>
        public override void PerformSpecificIntializationSteps(bool isNew, EntityBusinessObject parentObject)
        {
            TabTypeImage = Resources.Building;
            TabObject = TabObject ?? new Building();
            if (isNew)
            {
                SetParentID(parentObject);
                textEditBuildingName.Focus();
                //foreach (BuildingContact contact in TabBuilding.BuildingContacts)
                //{
                //    contact.ShouldValidate = false;
                //}
            }
        }

        /// <summary>
        /// Bind the controls of the building tab
        /// </summary>
        public override void SetBinding()
        {
            FillLookUps();

            spinEditGrossSF.Properties.MaxValue = int.MaxValue;
            spinEditGrossSF.Properties.MinValue = 0;

            spinEditGrossSF.EditValueChanging += UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditYearBuilt.EditValueChanging += UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditTotalOccupants.EditValueChanging += UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditFloorAreaRatio.EditValueChanging += UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditRentableSF.EditValueChanging += UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditNetSF.EditValueChanging += UIBLLInteraction.Instance.spinEdit_EditValueChanging;

            gridColumnCustomerId.FieldName = BuildingContact.CUSTOMER_ID_PROPERTY_NAME;
            gridColumnRoleId.FieldName = BuildingContact.BUILDING_ROLE_ID_PROPERTY_NAME;
            gridColumnContactEmail.FieldName = BuildingContact.EMAIL_PROPERTY_NAME;
            gridColumnContactPhone.FieldName = BuildingContact.PHONE_PROPERTY_NAME;

            BindControl(ParentTab, TEXT_PROPERTYNAME, TabObject, Building.NAME_PROPERTY_NAME);
            BindControl(textEditBuildingName, EDITVALUE_PROPERTYNAME, TabObject, Building.NAME_PROPERTY_NAME);
            BindControl(textEditCrmId, EDITVALUE_PROPERTYNAME, TabObject, Building.CRM_ID_PROPERTY_NAME);
            BindControl(textEditOrigionalBuildingId, EDITVALUE_PROPERTYNAME, TabObject, Building.OriginalBuildingId_PROPERTY_NAME);
            BindControl(spinEditYearBuilt, EDITVALUE_PROPERTYNAME, TabObject, Building.YEAR_BUILT_PROPERTY_NAME);
            BindControl(spinEditTotalOccupants, EDITVALUE_PROPERTYNAME, TabObject,
                        Building.TOTAL_OCCUPANTS_PROPERTY_NAME);
            BindControl(spinEditFloorAreaRatio, EDITVALUE_PROPERTYNAME, TabObject,
                        Building.FLOOR_AREA_RATIO_PROPERTY_NAME);
            BindControl(spinEditRentableSF, EDITVALUE_PROPERTYNAME, TabObject, Building.RENTABLE_SF_PROPERTY_NAME);
            BindControl(spinEditNetSF, EDITVALUE_PROPERTYNAME, TabObject, Building.NET_SF_PROPERTY_NAME);
            BindControl(spinEditGrossSF, EDITVALUE_PROPERTYNAME, TabObject, Building.GROSS_SF_PROPERTY_NAME);
            BindControl(checkEditISGrossSFApproximated, EDITVALUE_PROPERTYNAME, TabObject,
                        Building.IS_GROSS_SF_APPROXIMATED_PROPERTY_NAME);
            BindControl(memoEditBuildingNarrative, TEXT_PROPERTYNAME, TabObject, Building.NARRATIVE_PROPERTY_NAME);
            BindControl(textEditCountry, EDITVALUE_PROPERTYNAME, TabObject, Building.ADDRESS_COUNTRY_PROPERTY_NAME);
            BindControl(textEditState, EDITVALUE_PROPERTYNAME, TabObject, Building.ADDRESS_STATE_PROPERTY_NAME);
            BindControl(textEditCity, EDITVALUE_PROPERTYNAME, TabObject, Building.ADDRESS_CITY_PROPERTY_NAME);
            BindControl(textEditZip, EDITVALUE_PROPERTYNAME, TabObject, Building.ADDRESS_ZIP_PROPERTY_NAME);
            BindControl(textEditAddressStreet1, EDITVALUE_PROPERTYNAME, TabObject,
                        Building.ADDRESS_STREET_1_PROPERTY_NAME);
            BindControl(textEditAddressStreet2, EDITVALUE_PROPERTYNAME, TabObject,
                        Building.ADDRESS_STREET_2_PROPERTY_NAME);
            BindControl(gridControlComponentsAdded, DATASOURCE_PROPERTYNAME, TabObject,
                        Building.COMPONENTS_PROPERTY_NAME);
            BindControl(gridControlBuildingTypeAdd, DATASOURCE_PROPERTYNAME, TabObject,
                        Building.BUILDING_TYPES_PROPERTY_NAME);
            BindControl(gridControlBuildingContacts, DATASOURCE_PROPERTYNAME, TabObject,
                        Building.BUILDING_CONTACTS_PROPERTY_NAME);
            BindControl(lookUpEditProjectId, EDITVALUE_PROPERTYNAME, TabObject, Building.PROJECT_ID_PROPERTY_NAME);
            AddChildernChangesListeners();
            TabBuilding.ParentProject.PropertyChanged += ParentProject_PropertyChanged;
        }

        /// <summary>
        /// Sets the edit mode of the building tab
        /// </summary>
        /// <param name="isReadOnly">if true then the tab will be in ready only mode</param>
        /// <param name="isChangedByUser"></param>
        public override void SetEditMode(bool isReadOnly, bool isChangedByUser)
        {
            textEditCrmId.Properties.ReadOnly = isReadOnly;
            textEditBuildingName.Properties.ReadOnly = isReadOnly;
            textEditCity.Properties.ReadOnly = isReadOnly;
            textEditCountry.Properties.ReadOnly = isReadOnly;
            spinEditFloorAreaRatio.Properties.ReadOnly = isReadOnly;
            spinEditGrossSF.Properties.ReadOnly = isReadOnly;
            spinEditNetSF.Properties.ReadOnly = isReadOnly;
            spinEditRentableSF.Properties.ReadOnly = isReadOnly;
            textEditState.Properties.ReadOnly = isReadOnly;
            spinEditTotalOccupants.Properties.ReadOnly = isReadOnly;
            spinEditYearBuilt.Properties.ReadOnly = isReadOnly;
            textEditZip.Properties.ReadOnly = isReadOnly;
            memoEditBuildingNarrative.Properties.ReadOnly = isReadOnly;
            popupContainerEditBuildingType.Properties.ReadOnly = isReadOnly;
            textEditAddressStreet1.Properties.ReadOnly = isReadOnly;
            textEditAddressStreet2.Properties.ReadOnly = isReadOnly;

            checkEditISGrossSFApproximated.Enabled = !isReadOnly;

            gridControlComponentsAdded.EmbeddedNavigator.Buttons.Append.Visible = !isReadOnly;
            gridControlComponentsAdded.EmbeddedNavigator.Buttons.Remove.Visible = !isReadOnly;
            gridControlBuildingTypeAdd.EmbeddedNavigator.Buttons.Remove.Visible = !isReadOnly;

            gridViewBuildingContacts.OptionsBehavior.Editable = !isReadOnly;
            gridControlBuildingContacts.EmbeddedNavigator.Buttons.Append.Visible = !isReadOnly;
            gridControlBuildingContacts.EmbeddedNavigator.Buttons.Remove.Visible = !isReadOnly;
            gridControlBuildingContacts.EmbeddedNavigator.Buttons.Edit.Visible = !isReadOnly;
            gridControlBuildingContacts.EmbeddedNavigator.Buttons.CancelEdit.Visible = !isReadOnly;
            gridControlBuildingContacts.EmbeddedNavigator.Buttons.EndEdit.Visible = !isReadOnly;
        }

        /// <summary>
        /// Fill the lookup controls with the collections of objects from the cache
        /// </summary>
        private void FillLookUps()
        {
            try
            {
                lookUpEditProjectId.Properties.DataSource = UIBLLInteraction.Instance.ProjectsCollection;
                gridControlBuildingTypeView.DataSource = BusinessLayerCache.Instance.GetAllBuildingTypes();
                repositoryItemGridLookUpEditCustomerId.DataSource = BusinessLayerCache.Instance.GetAllCustomers();
                repositoryItemGridLookUpEditRole.DataSource = BusinessLayerCache.Instance.GetAllBuildingRoles();
            }
            catch (DataAccessException dataAccessException)
            {
                Application.Logger.LogException(dataAccessException);
            }
        }

        /// <summary>
        /// Add handlers to child collections to allow the parent building to know that a child change and so to
        /// update the tab status and enable the apply button for instance
        /// </summary>
        private void AddChildernChangesListeners()
        {
            try
            {
                TabBuilding.Components.ListChanged += Components_ListChanged;
                TabBuilding.Components.RaiseListChangedEvents = true;
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }

            try
            {
                TabBuilding.BuildingTypes.ListChanged += BuildingTypes_ListChanged;
                TabBuilding.BuildingTypes.RaiseListChangedEvents = true;
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }

            try
            {
                TabBuilding.BuildingContacts.ListChanged += BuildingContacts_ListChanged;
                TabBuilding.BuildingContacts.RaiseListChangedEvents = true;
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }

            try
            {
                BusinessLayerCache.Instance.GetAllCustomers().RaiseListChangedEvents = true;
                BusinessLayerCache.Instance.GetAllCustomers().ListChanged += Customers_ListChanged;
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }
        }

        /// <summary>
        /// Unregisters the handlers in the tab
        /// </summary>
        public override void ClearHandlers()
        {
            try
            {
                TabBuilding.Components.ListChanged -= Components_ListChanged;
                TabBuilding.BuildingTypes.ListChanged -= BuildingTypes_ListChanged;
                TabBuilding.BuildingContacts.ListChanged -= BuildingContacts_ListChanged;
                TabBuilding.ParentProject.PropertyChanged -= ParentProject_PropertyChanged;
            }
            catch (NullReferenceException)
            {
                MessageBox.Show(CLEAR_HANDLERS_ERROR, UIBLLInteraction.ERROR_MESSAGE_TITLE, MessageBoxButtons.OK,
                                MessageBoxIcon.Error);
            }

            try
            {
                BusinessLayerCache.Instance.GetAllCustomers().ListChanged -= Customers_ListChanged;
            }
            catch (NullReferenceException)
            {
            }
            catch (DataAccessException)
            {
            }

            spinEditGrossSF.EditValueChanging -= UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditYearBuilt.EditValueChanging -= UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditTotalOccupants.EditValueChanging -= UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditFloorAreaRatio.EditValueChanging -= UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditRentableSF.EditValueChanging -= UIBLLInteraction.Instance.spinEdit_EditValueChanging;
            spinEditNetSF.EditValueChanging -= UIBLLInteraction.Instance.spinEdit_EditValueChanging;
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Parent related actions

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Add the ID of the current building object into the dictionary if it was enabled for editing
        /// </summary>
        public override void AddParentIDToEditDictionary()
        {
            try
            {
                UIBLLInteraction.Instance.LockProject(GetParentProjectID(),
                                                      UIBLLInteraction.Instance.ProjectsNav.GetObjectByID<Project>(
                                                          GetParentProjectID()));
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }
        }

        /// <summary>
        /// Add the current building object into the collection of the parent project if it was new building
        /// </summary>
        public override void AddBusinessObjectToCollection()
        {
            try
            {
                var parentProject =
                    UIBLLInteraction.Instance.ProjectsNav.GetObjectByID<Project>(GetParentProjectID()) as Project;
                if (parentProject != null) parentProject.Buildings.AddSavedObject(TabBuilding);
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }
        }

        /// <summary>
        /// Get the parent ID for the current building
        /// </summary>
        /// <returns></returns>
        public override int GetParentProjectID()
        {
            int Id = 0;
            try
            {
                if (TabBuilding != null)
                {
                    Id = (TabBuilding.ProjectId == null) ? 0 : TabBuilding.ProjectId.Value;
                }
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }
            return Id;
        }

        /// <summary>
        /// Set the parent ID for the current building object
        /// </summary>
        /// <param name="parentObject"></param>
        public override void SetParentID(EntityBusinessObject parentObject)
        {
            if (TabBuilding != null && parentObject != null)
            {
                TabBuilding.ProjectId = parentObject.Id;
                TabBuilding.ParentProject = parentObject as Project;
            }
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Save related actions

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Checks if a property change should notify the tab
        /// </summary>
        /// <param name="propertyName"></param>
        /// <returns></returns>
        public override bool ShouldPropertyNotifyTab(string propertyName)
        {
            if (propertyName == Building.COMPONENTS_PROPERTY_NAME)
            {
                if (isDeletingComponents)
                {
                    return true;
                }
                return false;
            }
            if (propertyName == Building.PROJECT_ID_PROPERTY_NAME)
            {
                return false;
            }
            return true;
        }

        /// <summary>
        /// Posts the values in the controls that are not yet comitted to the datasource because the user
        /// clicked save or cancel without leaving the editor to another editor first.
        /// </summary>
        public override void PostValues()
        {
            GridViewPostValues(gridViewBuildingContacts);
            GridViewPostValues(gridViewBuildingTypesAdd);

            textEditAddressStreet1.DoValidate();
            textEditAddressStreet2.DoValidate();
            textEditBuildingName.DoValidate();
            textEditCity.DoValidate();
            textEditCountry.DoValidate();
            textEditCrmId.DoValidate();
            textEditState.DoValidate();
            spinEditYearBuilt.DoValidate();
            textEditZip.DoValidate();

            memoEditBuildingNarrative.DoValidate();

            spinEditFloorAreaRatio.DoValidate();
            spinEditGrossSF.DoValidate();
            spinEditNetSF.DoValidate();
            spinEditRentableSF.DoValidate();
            spinEditTotalOccupants.DoValidate();
        }

        /// <summary>
        /// Apply project's specific actions after saving a project
        /// </summary>
        public override void AfterSaveActions()
        {
            UIBLLInteraction.Instance.RefreshBuildingsView();
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Validation

        //---------------------------------------------------------------------------------------------
        public override void ShowHideErrorIcons()
        {
            try
            {
                bool areAddressesInvalid =
                    IsPropertyInvalid(Building.ADDRESS_CITY_FRIENDLY_PROPERTY_NAME) ||
                    IsPropertyInvalid(Building.ADDRESS_COUNTRY_FRIENDLY_PROPERTY_NAME) ||
                    IsPropertyInvalid(Building.ADDRESS_STATE_FRIENDLY_PROPERTY_NAME) ||
                    IsPropertyInvalid(Building.ADDRESS_STREET_1_FRIENDLY_PROPERTY_NAME) ||
                    IsPropertyInvalid(Building.ADDRESS_STREET_2_FRIENDLY_PROPERTY_NAME) ||
                    IsPropertyInvalid(Building.ADDRESS_ZIP_FRIENDLY_PROPERTY_NAME);


                string cityError = GetErrorText(Building.ADDRESS_CITY_FRIENDLY_PROPERTY_NAME);
                string countryError = GetErrorText(Building.ADDRESS_COUNTRY_FRIENDLY_PROPERTY_NAME);
                string stateError = GetErrorText(Building.ADDRESS_STATE_FRIENDLY_PROPERTY_NAME);
                string address1Error = GetErrorText(Building.ADDRESS_STREET_1_FRIENDLY_PROPERTY_NAME);
                string address2Error = GetErrorText(Building.ADDRESS_STREET_2_FRIENDLY_PROPERTY_NAME);
                string zipError = GetErrorText(Building.ADDRESS_ZIP_FRIENDLY_PROPERTY_NAME);
                string totalError = string.Empty;

                bool areBuildingTypesInvalid = IsPropertyInvalid(Building.BUILDING_TYPES_FRIENDLY_PROPERTY_NAME);

                if (cityError != string.Empty)
                {
                    totalError += "- " + cityError + ".\n";
                }


                if (countryError != string.Empty)
                {
                    totalError += "- " + countryError + ".\n";
                }

                if (stateError != string.Empty)
                {
                    totalError += "- " + stateError + ".\n";
                }

                if (address1Error != string.Empty)
                {
                    totalError += "- " + address1Error + ".\n";
                }
                if (address2Error != string.Empty)
                {
                    totalError += "- " + address2Error + ".\n";
                }
                if (zipError != string.Empty)
                {
                    totalError += "- " + zipError + ".\n";
                }

                if (totalError != string.Empty)
                {
                    totalError += "- " + totalError + ".";
                }
                xtraTabPageAddress.Image = (areAddressesInvalid) ? Resources.Error : null;
                xtraTabPageAddress.Tooltip = (areAddressesInvalid) ? totalError : string.Empty;

                if (areAddressesInvalid)
                {
                    xtraTabPageDetails.Image = Resources.Error;
                    xtraTabPageDetails.Tooltip = "Some controls are invalid";
                }
                else
                {
                    xtraTabPageDetails.Image = null;
                    xtraTabPageDetails.Tooltip = string.Empty;
                }

                layoutControlGroupBuildingTypes.CaptionImage = (areBuildingTypesInvalid) ? Resources.Error : null;
                layoutControlGroupBuildingTypes.OptionsToolTip.ToolTip = (areBuildingTypesInvalid)
                                                                             ? GetErrorText(
                                                                                   Building.
                                                                                       BUILDING_TYPES_FRIENDLY_PROPERTY_NAME)
                                                                             : string.Empty;

                bool areContactsInvalid = IsPropertyInvalid(Building.BUILDING_CONTACTS_FRIENDLY_PROPERTY_NAME);

                layoutControlGroupBuildingContacts.CaptionImage = (areContactsInvalid) ? Resources.Error : null;
                layoutControlGroupBuildingContacts.OptionsToolTip.ToolTip = (areContactsInvalid)
                                                                                ? GetErrorText(
                                                                                      Building.
                                                                                          BUILDING_CONTACTS_FRIENDLY_PROPERTY_NAME)
                                                                                : string.Empty;

                bool isCRMIDInvalid = IsPropertyInvalid(Building.CRM_ID_PROPERTY_NAME);
                bool isNameInvalid = IsPropertyInvalid(Building.NAME_PROPERTY_NAME);
                bool isYearBuildInvalid = IsPropertyInvalid(Building.YEAR_BUILT_FRIENDLY_PROPERTY_NAME);
                bool isTotalOccupantsInvalid = IsPropertyInvalid(Building.TOTAL_OCCUPANTS_FRIENDLY_PROPERTY_NAME);
                bool isGrossSFInvalid = IsPropertyInvalid(Building.GROSS_SF_FRIENDLY_PROPERTY_NAME);

                if (isCRMIDInvalid ||
                    isNameInvalid ||
                    isYearBuildInvalid ||
                    isTotalOccupantsInvalid ||
                    isGrossSFInvalid ||
                    areBuildingTypesInvalid ||
                    areContactsInvalid)
                {
                    xtraTabPageGeneralInformation.Image = Resources.Error;
                    xtraTabPageGeneralInformation.Tooltip = "Some controls are invalid";
                }
                else
                {
                    xtraTabPageGeneralInformation.Image = null;
                    xtraTabPageGeneralInformation.Tooltip = string.Empty;
                }
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }
        }

        public override void PerformCustomValidation()
        {
            foreach (BuildingContact contact in TabBuilding.BuildingContacts)
            {
                contact.ShouldValidate = true;
            }
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        //---------------------------------------------------------------------------------------------

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Binding Methods

        //---------------------------------------------------------------------------------------------
        //---------------------------------------------------------------------------------------------

        #endregion

        #region Building & Modules Specific logic

        #region Components

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Opens a new tab to add a new component to the current building
        /// </summary>
        private void AddNewComponent()
        {
            try
            {
                if (TabBuilding.State != BusinessObjectState.New)
                {
                    UIBLLInteraction.Instance.New(EntityType.Components, TabObject);
                }
                else
                {
                    MessageBox.Show(ADD_COMPONENTS_ERROR, UIBLLInteraction.ERROR_MESSAGE_TITLE, MessageBoxButtons.OK,
                                    MessageBoxIcon.Error);
                }
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }
        }

        /// <summary>
        /// Open the current double clicked component
        /// </summary>
        private void OpenComponent()
        {
            var openedComponent = gridViewComponentsAdd.GetFocusedRow() as Component;
            try
            {
                var openedObject = openedComponent as EntityBusinessObject;
                if (openedObject != null)
                {
                    UIBLLInteraction.Instance.Open(ref openedObject);
                }
                else
                {
                    MessageBox.Show(ITEM_HAS_NO_VALUE_ERROR, UIBLLInteraction.ERROR_MESSAGE_TITLE, MessageBoxButtons.OK,
                                    MessageBoxIcon.Error);
                }
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }
        }

        /// <summary>
        /// Determines if the component is assigned or not
        /// </summary>
        /// <param name="component"></param>
        /// <returns></returns>
        private bool IsComponentAssigned(Component component)
        {
            bool isAssigned = false;
            try
            {
                Project parentProject = TabBuilding.ParentProject;
                if (parentProject != null && component != null)
                {
                    foreach (Scenario scenario in parentProject.Scenarios)
                    {
                        foreach (ScenarioComponent scenarioComponent in scenario.Components)
                        {
                            if (scenarioComponent.Component == component)
                            {
                                isAssigned = true;
                                break;
                            }
                        }
                    }
                }
            }
            catch (NullReferenceException nullReferenceException)
            {
                Application.Logger.LogException(nullReferenceException);
            }
            return isAssigned;
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region BuildingTypes

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Add a checked building type to the list of building types selected
        /// </summary>
        private void AddCheckedBuildingTypes()
        {
            int[] selectedTypes = gridViewBuildingTypeView.GetSelectedRows();
            if (selectedTypes.Length != 0)
            {
                var buildingAssignedTypes = new Dictionary<int, BuildingBuildingType>();
                try
                {
                    foreach (BuildingBuildingType assignedType in TabBuilding.BuildingTypes)
                    {
                        try
                        {
                            buildingAssignedTypes.Add(assignedType.BuildingTypeId, assignedType);
                        }
                        catch (ArgumentException argumentException)
                        {
                            Application.Logger.LogException(argumentException);
                        }
                    }
                }
                catch (NullReferenceException nullReferenceException)
                {
                    Application.Logger.LogException(nullReferenceException);
                    //UIBLLInteraction.Instance.ShowException(nullReferenceException);
                }

                foreach (int handle in selectedTypes)
                {
                    gridViewBuildingTypeView.UnselectRow(handle);
                    var lookUpBusinessObject = gridViewBuildingTypeView.GetRow(handle) as
                                               LookUpBusinessObject;


                    try
                    {
                        if (lookUpBusinessObject != null)
                        {
                            if (lookUpBusinessObject.Id != null)
                            {
                                BuildingBuildingType checkType;
                                buildingAssignedTypes.TryGetValue(lookUpBusinessObject.Id.Value, out checkType);
                                if (checkType == null)
                                {
                                    checkType = new BuildingBuildingType(lookUpBusinessObject);
                                    try
                                    {
                                        TabBuilding.BuildingTypes.Add(checkType);
                                    }
                                    catch (ArgumentException argumentException)
                                    {
                                        Application.Logger.LogException(argumentException);
                                    }
                                }
                            }
                        }
                    }
                    catch (NullReferenceException nullReferenceException)
                    {
                        Application.Logger.LogException(nullReferenceException);
                        //UIBLLInteraction.Instance.ShowException(nullReferenceException);
                    }
                }
            }
            popupContainerControlBuildingType.OwnerEdit.ClosePopup();
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region BuildingContacts

        //---------------------------------------------------------------------------------------------
        //---------------------------------------------------------------------------------------------

        #endregion

        //---------------------------------------------------------------------------------------------

        //---------------------------------------------------------------------------------------------

        #endregion

        //---------------------------------------------------------------------------------------------

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Handlers

        #region BuildingTypes

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Calls a method to add checked building types to the building
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void simpleButtonAddBuildingType_Click(object sender, EventArgs e)
        {
            AddCheckedBuildingTypes();
        }

        /// <summary>
        /// Calls a method to remove the selected building types
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void gridControlBuildingTypeAdd_EmbeddedNavigator_ButtonClick(object sender,
                                                                              NavigatorButtonClickEventArgs e)
        {
            switch (e.Button.ButtonType)
            {
                case NavigatorButtonType.Remove:
                    e.Handled = true;
                    try
                    {
                        DeleteSelectedGridViewObjects(gridViewBuildingTypesAdd, TabBuilding.BuildingTypes);
                    }
                    catch (NullReferenceException nullReferenceException)
                    {
                        Application.Logger.LogException(nullReferenceException);
                    }
                    break;
                case NavigatorButtonType.Custom:
                    e.Handled = true;
                    if (e.Button.Hint == "ShowHideFilter")
                    {
                        gridViewBuildingTypesAdd.OptionsView.ShowAutoFilterRow =
                            !gridViewBuildingTypesAdd.OptionsView.ShowAutoFilterRow;
                    }
                    break;
                default:
                    break;
            }
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Components

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Calls a method to add new component or delete selected components when clicking navigator buttons
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void gridControlComponentsAdded_EmbeddedNavigator_ButtonClick(object sender,
                                                                              NavigatorButtonClickEventArgs e)
        {
            switch (e.Button.ButtonType)
            {
                case NavigatorButtonType.Append:
                    e.Handled = true;
                    AddNewComponent();
                    break;
                case NavigatorButtonType.Remove:
                    if (MessageBox.Show("Are you sure you want to delete the entire component(s)", UIBLLInteraction.QUESTION_MESSAGE_TITLE, MessageBoxButtons.OKCancel, MessageBoxIcon.Question) == DialogResult.OK)
                    {
                        isDeletingComponents = true;
                        e.Handled = true;
                        bool isAllComponentsClosed = true;
                        bool isAllComponentsUnassigned = true;

                        //We use this to cancel responding the events and refill the group again after the 
                        //removing is done
                        //UIBLLInteraction.Instance.ComponentsGroup.RespondToEvent = false;
                        UIBLLInteraction.Instance.AllowComponentsFilteration = false;

                        int[] selectedComponents = gridViewComponentsAdd.GetSelectedRows();
                        var indexes = new Hashtable();
                        foreach (int handle in selectedComponents)
                        {
                            indexes.Add(handle, gridViewComponentsAdd.GetDataSourceRowIndex(handle));
                        }

                        foreach (int handle in indexes.Keys)
                        {
                            int index = -1;
                            try
                            {
                                index = Convert.ToInt32(indexes[handle]);
                            }
                            catch (OverflowException OverflowException)
                            {
                                Application.Logger.LogException(OverflowException);
                            }
                            catch (InvalidCastException invalidCastException)
                            {
                                Application.Logger.LogException(invalidCastException);
                            }
                            catch (FormatException formatException)
                            {
                                Application.Logger.LogException(formatException);
                            }


                            if (TabBuilding != null)
                            {
                                var objectToDelete = TabBuilding.Components[index] as EntityBusinessObject;
                                Component componentToDelete = TabBuilding.Components[index];
                                bool isAssigned = false;
                                if (componentToDelete != null)
                                {
                                    if (IsComponentAssigned(componentToDelete))
                                    {
                                        isAllComponentsUnassigned = false;
                                        isAssigned = true;
                                    }
                                }
                                if (objectToDelete != null)
                                {
                                    if (!isAssigned)
                                    {
                                        if (UIBLLInteraction.Instance.CheckIfTabOpened(objectToDelete, false, 0))
                                        {
                                            isAllComponentsClosed = false;
                                        }
                                        else
                                        {
                                            try
                                            {
                                                TabBuilding.Components.RemoveAt(index);
                                            }
                                            catch (DataAccessException dataAccessException)
                                            {
                                                UIBLLInteraction.Instance.ShowException(dataAccessException);
                                                Application.Logger.LogException(dataAccessException);
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //We use this to cancel responding the events and refill the group again after the 
                        //removing is done
                        //UIBLLInteraction.Instance.ComponentsGroup.FillGroup();
                        //UIBLLInteraction.Instance.ComponentsGroup.RespondToEvent = true;
                        UIBLLInteraction.Instance.AllowComponentsFilteration = true;

                        if (!isAllComponentsClosed)
                        {
                            MessageBox.Show(
                                "Not all selected components were deleted, please close opened components to delete them.",
                                "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        }
                        if (!isAllComponentsUnassigned)
                        {
                            MessageBox.Show(
                                "Not all selected components were deleted, components assigned to scenarios can't be deleted, please unassign them first.",
                                "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        }
                        isDeletingComponents = false;
                    }
                    
                    break;
            }
        }

        /// <summary>
        /// Calls a method to open the selected component
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void gridControlComponentsAdded_DoubleClick(object sender, EventArgs e)
        {
            GridHitInfo gridViewComponentsAddHitInfo =
                gridViewComponentsAdd.CalcHitInfo(gridControlComponentsAdded.PointToClient(Cursor.Position));
            if (gridViewComponentsAddHitInfo.InRow)
            {
                OpenComponent();
            }
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Project

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Open the parent project for the building in a tab page
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void lookUpEditProjectId_ButtonClick(object sender, ButtonPressedEventArgs e)
        {
            if (e.Button.Kind == ButtonPredefines.Ellipsis)
            {
                if (lookUpEditProjectId.EditValue != null)
                {
                    int Id = -1;
                    try
                    {
                        Id = Convert.ToInt32(lookUpEditProjectId.EditValue);
                    }
                    catch (OverflowException OverflowException)
                    {
                        Application.Logger.LogException(OverflowException);
                    }
                    catch (InvalidCastException invalidCastException)
                    {
                        Application.Logger.LogException(invalidCastException);
                    }
                    catch (FormatException formatException)
                    {
                        Application.Logger.LogException(formatException);
                    }
                    EntityBusinessObject parentProject = UIBLLInteraction.Instance.ProjectsNav.GetObjectByID<Project>(Id);
                    if (parentProject != null)
                    {
                        UIBLLInteraction.Instance.Open(ref parentProject);
                    }
                }
            }
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        #region Binding complete and property changed events

        //---------------------------------------------------------------------------------------------
        /// <summary>
        /// Notify the tab that a change happend in it
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void BuildingTypes_ListChanged(object sender, ListChangedEventArgs e)
        {
            if (TabBuilding != null && TabState != EntityTabState.Unchanged)
            {
                if (e.ListChangedType == ListChangedType.ItemAdded ||
                    e.ListChangedType == ListChangedType.ItemDeleted)
                {
                    TabBuilding.NotifyPropertyChanged(Building.BUILDING_TYPES_PROPERTY_NAME);
                }
            }
        }

        /// <summary>
        /// Notify the tab that a change happend in it
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void Components_ListChanged(object sender, ListChangedEventArgs e)
        {
            if (TabBuilding != null && e.ListChangedType == ListChangedType.ItemDeleted &&
                TabState != EntityTabState.Unchanged)
            {
                TabBuilding.NotifyPropertyChanged(Building.COMPONENTS_PROPERTY_NAME);
            }
        }

        /// <summary>
        /// Notify the tab that a change happend in it
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void BuildingContacts_ListChanged(object sender, ListChangedEventArgs e)
        {
            if (TabBuilding != null && TabState != EntityTabState.Unchanged)
            {
                foreach (BuildingContact contact in TabBuilding.BuildingContacts)
                {
                    contact.ShouldValidate = true;
                }
                TabBuilding.NotifyPropertyChanged(Building.BUILDING_CONTACTS_PROPERTY_NAME);
            }
        }

        /// <summary>
        /// Handles showing or hiding the filter of the grid
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void gridControlBuildingContacts_EmbeddedNavigator_ButtonClick(object sender,
                                                                               NavigatorButtonClickEventArgs e)
        {
            switch (e.Button.ButtonType)
            {
                case NavigatorButtonType.Custom:
                    e.Handled = true;
                    if (e.Button.Hint == "ShowHideFilter")
                    {
                        gridViewBuildingContacts.OptionsView.ShowAutoFilterRow =
                            !gridViewBuildingContacts.OptionsView.ShowAutoFilterRow;
                    }
                    break;
                case NavigatorButtonType.Remove:
                    e.Handled = true;
                    try
                    {
                        DeleteSelectedGridViewObjects(gridViewBuildingContacts, TabBuilding.BuildingContacts);
                    }
                    catch (NullReferenceException nullReferenceException)
                    {
                        Application.Logger.LogException(nullReferenceException);
                    }
                    break;
                default:
                    break;
            }
        }

        /// <summary>
        /// Changes the state of the current tab when its parent is locked.
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void ParentProject_PropertyChanged(object sender, PropertyChangedEventArgs e)
        {
            if (TabBuilding != null)
            {
                if (TabBuilding.ParentProject != null)
                {
                    if (e.PropertyName == Project.STATUS_ID_PROPERTY_NAME)
                    {
                        SetEditMode(true, false);
                        UpdateActionButtons();
                    }
                }
            }
        }

        /// <summary>
        /// Refreshes the customers
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void Customers_ListChanged(object sender, ListChangedEventArgs e)
        {
            repositoryItemGridLookUpEditCustomerId.DataSource = BusinessLayerCache.Instance.GetAllCustomers();
            gridViewBuildingContacts.RefreshData();
            gridControlBuildingContacts.RefreshDataSource();
        }

        //---------------------------------------------------------------------------------------------

        #endregion

        //---------------------------------------------------------------------------------------------

        private void popupContainerEditBuildingType_QueryPopUp(object sender, CancelEventArgs e)
        {
            gridViewBuildingTypeView.ActiveFilterCriteria = string.Empty;
            gridViewBuildingTypeView.ActiveFilterString = string.Empty;
        }

        /// <summary>
        /// Clears the filter after opening
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void DropDown_QueryPopUp(object sender, CancelEventArgs e)
        {
            ((GridLookUpEdit) sender).Properties.View.ActiveFilterCriteria = string.Empty;
            ((GridLookUpEdit) sender).Properties.View.ActiveFilterString = string.Empty;
        }

        public void GridView_ShownEditor(object sender, EventArgs e)
        {
            //UIBLLInteraction.Instance.MainForm.spellChecker1.SetShowSpellCheckMenu((sender as GridView).ActiveEditor, true);
        }

        //---------------------------------------------------------------------------------------------

        #endregion
    }
}